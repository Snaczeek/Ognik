{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/mateu/Desktop/OGNIK/Ognik/frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"C:/Users/mateu/Desktop/OGNIK/Ognik/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"C:/Users/mateu/Desktop/OGNIK/Ognik/frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{createContext,useState,useEffect}from'react';import jwt_decode from\"jwt-decode\";import{useNavigate}from'react-router-dom';import{w3cwebsocket as W3CWebSocket}from'websocket';import{jsx as _jsx}from\"react/jsx-runtime\";var AuthContext=/*#__PURE__*/createContext();export default AuthContext;export var AuthProvider=function AuthProvider(_ref){var children=_ref.children;// Checking if user has token in browser storage\n// if so then, parsing value into json format\nvar _useState=useState(function(){return localStorage.getItem('authToken')?JSON.parse(localStorage.getItem('authToken')):null;}),_useState2=_slicedToArray(_useState,2),authToken=_useState2[0],setAuthTokens=_useState2[1];// decoding jwt token into useable block\nvar _useState3=useState(function(){return localStorage.getItem('authToken')?jwt_decode(localStorage.getItem('authToken')):null;}),_useState4=_slicedToArray(_useState3,2),user=_useState4[0],setUser=_useState4[1];var _useState5=useState(true),_useState6=_slicedToArray(_useState5,2),loading=_useState6[0],setLoading=_useState6[1];var url=\"ws://localhost:8000/ws/socket-server/\";var _useState7=useState(function(){return localStorage.getItem('authToken')?new W3CWebSocket(url+\"?token=\"+String(authToken.access)):null;}),_useState8=_slicedToArray(_useState7,2),WebSocket=_useState8[0],setWebSocket=_useState8[1];var navigate=useNavigate();// Must be in try block \n// Because on first load Websocket ist set to NULL so .onclose property doesn't exist \ntry{// If Websocket connection was interruptedly closed\n// Refresh page \nWebSocket.onclose=function(){console.log(\"AuthContext: Websocket Closed\");window.location.reload();};}catch(e){}// login function\nvar loginUser=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(e){var response,data;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:e.preventDefault();// fetching credentials to django backend\n_context.next=3;return fetch('http://localhost:8000/users/token/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'username':e.target.username.value,'password':e.target.password.value})});case 3:response=_context.sent;_context.next=6;return response.json();case 6:data=_context.sent;// if response form django is positive \n// saving token data to browser storage (at this point user is logged)\nif(response.status===200){setAuthTokens(data);setUser(jwt_decode(data.access));if(!WebSocket){setWebSocket(new W3CWebSocket(url+\"?token=\"+String(data.access)));}localStorage.setItem('authToken',JSON.stringify(data));navigate('/test/friends');window.location.reload();}else{document.getElementsByClassName('login-error-message')[0].innerHTML='Incorrect username or password';document.getElementById(\"login-username\").style.borderColor=\"rgb(255, 80, 80)\";document.getElementById(\"login-username\").style.borderWidth='2px';document.getElementById(\"login-password\").style.borderColor=\"rgb(255, 80, 80)\";document.getElementById(\"login-password\").style.borderWidth='2px';}case 8:case\"end\":return _context.stop();}},_callee);}));return function loginUser(_x){return _ref2.apply(this,arguments);};}();// logout function\nvar logoutUser=function logoutUser(){setAuthTokens(null);setUser(null);// clearing users web storage\nlocalStorage.removeItem('authToken');navigate('/');};// updating access token\nvar updateToken=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){var response,data;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fetch('http://localhost:8000/users/token/refresh/',{method:'POST',headers:{'Content-Type':'application/json'},// if refresh token exist, send it\n// if not, send null\nbody:JSON.stringify({'refresh':authToken===null||authToken===void 0?void 0:authToken.refresh})});case 2:response=_context2.sent;_context2.next=5;return response.json();case 5:data=_context2.sent;// saving new tokens\nif(response.status===200){setAuthTokens(data);setUser(jwt_decode(data.access));localStorage.setItem('authToken',JSON.stringify(data));}else{logoutUser();}if(loading){setLoading(false);}case 8:case\"end\":return _context2.stop();}},_callee2);}));return function updateToken(){return _ref3.apply(this,arguments);};}();// context data for provider\nvar contextData={user:user,authToken:authToken,loginUser:loginUser,logoutUser:logoutUser,WebSocket:WebSocket};useEffect(function(){// before children are rendered \n// update token\nif(loading){updateToken();}// run updateToken() every 4 minutes\nvar s4Minutes=1000*60*4;var interval=setInterval(function(){if(authToken){updateToken();}},s4Minutes);return function(){return clearInterval(interval);};},[authToken,loading,WebSocket]);// returnig contex data for children\nreturn/*#__PURE__*/_jsx(AuthContext.Provider,{value:contextData,children:loading?null:children});};","map":{"version":3,"names":["createContext","useState","useEffect","jwt_decode","useNavigate","w3cwebsocket","W3CWebSocket","AuthContext","AuthProvider","children","localStorage","getItem","JSON","parse","authToken","setAuthTokens","user","setUser","loading","setLoading","url","String","access","WebSocket","setWebSocket","navigate","onclose","console","log","window","location","reload","e","loginUser","preventDefault","fetch","method","headers","body","stringify","target","username","value","password","response","json","data","status","setItem","document","getElementsByClassName","innerHTML","getElementById","style","borderColor","borderWidth","logoutUser","removeItem","updateToken","refresh","contextData","s4Minutes","interval","setInterval","clearInterval"],"sources":["C:/Users/mateu/Desktop/OGNIK/Ognik/frontend/src/context/AuthContext.js"],"sourcesContent":["import { createContext, useState, useEffect } from 'react';\r\nimport jwt_decode from \"jwt-decode\";\r\nimport { useNavigate } from 'react-router-dom'\r\nimport { w3cwebsocket as W3CWebSocket} from 'websocket';\r\n\r\nconst AuthContext = createContext();\r\n\r\nexport default AuthContext\r\n\r\nexport const AuthProvider = ({children}) => {\r\n    \r\n    // Checking if user has token in browser storage\r\n    // if so then, parsing value into json format\r\n    let [authToken, setAuthTokens] = useState(() => localStorage.getItem('authToken') ? JSON.parse(localStorage.getItem('authToken')) : null)\r\n    // decoding jwt token into useable block\r\n    let [user, setUser] = useState(() => localStorage.getItem('authToken') ? jwt_decode(localStorage.getItem('authToken')) : null)\r\n    \r\n    let [loading, setLoading] = useState(true)\r\n    \r\n    \r\n    let url = `ws://localhost:8000/ws/socket-server/`\r\n    let [WebSocket, setWebSocket] = useState(() => localStorage.getItem('authToken') ? new W3CWebSocket(url + \"?token=\" + String(authToken.access)) : null)\r\n    \r\n    const navigate = useNavigate()\r\n    \r\n    // Must be in try block \r\n    // Because on first load Websocket ist set to NULL so .onclose property doesn't exist \r\n    try{\r\n        // If Websocket connection was interruptedly closed\r\n        // Refresh page \r\n        WebSocket.onclose = () => {\r\n            console.log(\"AuthContext: Websocket Closed\")\r\n            window.location.reload();\r\n        }\r\n    }catch(e){\r\n    \r\n    }\r\n    \r\n    // login function\r\n    let loginUser = async (e ) => {\r\n        e.preventDefault()\r\n        // fetching credentials to django backend\r\n        let response = await fetch('http://localhost:8000/users/token/', {\r\n            method: 'POST',\r\n            headers:{\r\n                'Content-Type':'application/json'\r\n            },\r\n            body:JSON.stringify({'username':e.target.username.value, 'password':e.target.password.value})\r\n        })\r\n        let data = await response.json()\r\n        \r\n        // if response form django is positive \r\n        // saving token data to browser storage (at this point user is logged)\r\n        if(response.status === 200)\r\n        {\r\n            setAuthTokens(data)\r\n            setUser(jwt_decode(data.access))\r\n            if (!WebSocket){\r\n                setWebSocket(new W3CWebSocket(url + \"?token=\" + String(data.access)))\r\n            }\r\n            localStorage.setItem('authToken', JSON.stringify(data))\r\n            navigate('/test/friends')  \r\n            window.location.reload()             \r\n        }\r\n        else\r\n        {\r\n            document.getElementsByClassName('login-error-message')[0].innerHTML = 'Incorrect username or password'\r\n            document.getElementById(\"login-username\").style.borderColor = \"rgb(255, 80, 80)\"   \r\n            document.getElementById(\"login-username\").style.borderWidth = '2px' \r\n            document.getElementById(\"login-password\").style.borderColor = \"rgb(255, 80, 80)\"   \r\n            document.getElementById(\"login-password\").style.borderWidth = '2px' \r\n        }\r\n    }\r\n    \r\n    // logout function\r\n    let logoutUser = () => {\r\n        setAuthTokens(null)\r\n        setUser(null)\r\n        \r\n        // clearing users web storage\r\n        localStorage.removeItem('authToken')\r\n        navigate('/')\r\n    }\r\n    \r\n    // updating access token\r\n    let updateToken = async () => {\r\n        // fetching refresh token to django backend\r\n        let response = await fetch('http://localhost:8000/users/token/refresh/', {\r\n            method: 'POST',\r\n            headers:{\r\n                'Content-Type':'application/json'\r\n            },\r\n            // if refresh token exist, send it\r\n            // if not, send null\r\n            body:JSON.stringify({'refresh': authToken?.refresh})\r\n        })\r\n        let data = await response.json()\r\n\r\n        // saving new tokens\r\n        if (response.status === 200){\r\n            setAuthTokens(data)\r\n            setUser(jwt_decode(data.access))\r\n            localStorage.setItem('authToken', JSON.stringify(data))\r\n        }else\r\n        {\r\n            logoutUser()\r\n        }\r\n        \r\n        if(loading){\r\n            setLoading(false)\r\n        }\r\n    }\r\n    \r\n    // context data for provider\r\n    let contextData = {\r\n        user:user,\r\n        authToken:authToken,\r\n        loginUser:loginUser,\r\n        logoutUser: logoutUser,\r\n        WebSocket:WebSocket,\r\n    }\r\n    \r\n    useEffect(() => {\r\n   \r\n        \r\n        // before children are rendered \r\n        // update token\r\n        if(loading){\r\n            updateToken()\r\n        }\r\n    \r\n\r\n        // run updateToken() every 4 minutes\r\n        let s4Minutes = 1000 * 60 * 4\r\n        let interval = setInterval(() => {\r\n            if(authToken){\r\n                updateToken()\r\n            }\r\n        }, s4Minutes)\r\n        return ()=> clearInterval(interval)\r\n        \r\n    }, [authToken, loading, WebSocket])\r\n    \r\n    // returnig contex data for children\r\n    return (\r\n        <AuthContext.Provider value={contextData}>\r\n        {/* render children after loading is done */}\r\n        {loading ? null : children}\r\n    </AuthContext.Provider>\r\n    );\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}